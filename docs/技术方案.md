# 今天吃什么大转盘 - 技术方案文档

## 1. 技术架构概述

### 1.1 技术栈选型（全栈版）

- **前端框架**: Vue 3 (Composition API)
- **开发语言**: TypeScript（前后端统一）
- **构建工具**: Vite（前端）
- **路由管理**: Vue Router 4（前端）
- **状态管理**: Pinia（前端）
- **UI 组件库**: Element Plus + 自定义组件
- **CSS 预处理器**: SCSS
- **动画库**: CSS3 Animations + 必要时 GSAP
- **后端框架**: NestJS
- **数据库**: MySQL
- **ORM**: Prisma（或 TypeORM）
- **缓存/队列（可选）**: Redis
- **接口文档**: Swagger / OpenAPI 3
- **身份认证**: JWT（Access/Refresh Token），Bcrypt 密码哈希
- **容器化**: Docker + docker-compose
- **日志&监控**: pino + http-logger，中间件级 tracing（可接入 OpenTelemetry）
- **代码规范**: ESLint + Prettier
- **类型检查**: TypeScript + Vue TSC

### 1.2 架构设计原则

- **组件化开发**: 采用 Vue 3 Composition API，提高代码复用性
- **类型安全**: 全面使用 TypeScript，确保类型安全
- **响应式设计**: 移动优先，适配多种设备尺寸
- **性能优化**: 懒加载、代码分割、资源优化
- **可维护性**: 清晰的目录结构和代码组织

## 2. 项目目录结构

```
order-takeout-turntable/
├── apps/
│   ├── web/                         # 前端（现有项目迁移到此目录）
│   │   ├── public/
│   │   ├── src/
│   │   ├── index.html
│   │   ├── vite.config.ts
│   │   └── package.json
│   └── api/                         # 后端服务（NestJS）
│       ├── src/
│       │   ├── main.ts
│       │   ├── app.module.ts
│       │   ├── common/              # 拦截器/过滤器/中间件
│       │   ├── auth/                # 认证模块（JWT）
│       │   ├── users/               # 用户模块
│       │   ├── wheel/               # 套餐与选项模块（控制器/服务）
│       │   └── prisma/              # PrismaService（Prisma ORM 数据源）
│       ├── prisma/
│       │   └── schema.prisma        # 数据模型定义
│       ├── package.json
│       └── tsconfig.json
├── docker/
│   ├── api.Dockerfile
│   ├── web.Dockerfile
│   └── compose.yml                  # 启动 api + web + mysql + redis
├── docs/
│   ├── 需求文档.md
│   └── 技术方案.md
└── README.md
```

## 3. 核心模块设计

### 3.1 数据模型设计

#### 3.1.1 转盘套餐数据结构（应用层）
```typescript
interface WheelSet {
  id: string;                    // 唯一标识
  userId: string;                // 归属用户
  name: string;                  // 套餐名称
  items: WheelItem[];            // 餐食选项列表
  createdAt: Date;               // 创建时间
  updatedAt: Date;               // 更新时间
  version?: number;              // 乐观锁版本（可选）
}

interface WheelItem {
  id: string;                    // 唯一标识
  setId: string;                 // 所属套餐
  name: string;                  // 餐食名称
  color?: string;                // 扇形颜色（可选）
  order: number;                 // 排序权重
}

#### 3.1.2 数据库模型（Prisma + MySQL 示例）

```prisma
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  wheelSets WheelSet[]
}

model WheelSet {
  id        String     @id @default(cuid())
  userId    String
  name      String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  version   Int        @default(1)
  items     WheelItem[]
  user      User       @relation(fields: [userId], references: [id])
  @@index([userId])
}

model WheelItem {
  id        String   @id @default(cuid())
  setId     String
  name      String
  color     String?
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  set       WheelSet @relation(fields: [setId], references: [id])
  @@index([setId])
}
```
```

#### 3.1.3 应用状态结构（前端）
```typescript
interface AppState {
  wheelSets: WheelSet[];         // 转盘套餐列表（来源：API）
  currentWheelSetId: string;     // 当前选中的套餐ID
  isSpinning: boolean;           // 转盘是否正在旋转
  lastResult: WheelItem | null;  // 上次转动结果
  auth: { token?: string; user?: { id: string; email: string } };
}
```

### 3.2 组件架构设计

#### 3.2.1 转盘组件 (WheelCanvas.vue)
- **职责**: 渲染转盘视觉效果，处理旋转动画
- **输入**: 转盘数据、旋转角度、动画状态
- **输出**: 旋转完成事件、选中结果

#### 3.2.2 管理组件 (Management.vue)
- **职责**: 套餐管理界面，CRUD 操作
- **子组件**: 套餐列表、编辑表单、预览区域

### 3.3 状态管理设计

#### 3.3.1 Wheel Store (stores/wheel.ts)
- **状态**: 转盘套餐数据、当前选中套餐、旋转状态
- **操作**: 调用后端 API 完成增删改查（CRUD）、切换套餐、更新旋转状态
- **持久化**: 由后端数据库持久化，前端仅做内存缓存；必要时将 `currentWheelSetId` 存于 `localStorage` 以改善体验

#### 3.3.2 App Store (stores/app.ts)
- **状态**: 全局加载状态、主题设置、用户偏好
- **操作**: 全局状态管理

## 4. 技术实现方案（数据库版）

### 4.1 转盘渲染方案

#### 4.1.1 Canvas 渲染
- 使用 HTML5 Canvas API 绘制转盘
- 动态计算扇形角度和位置
- 支持自定义颜色和文字

#### 4.1.2 动画实现
- CSS3 Transform + Transition 实现基础旋转
- 使用 RequestAnimationFrame 实现流畅动画
- 缓动函数实现逐渐减速效果

### 4.2 数据存储方案

#### 4.2.1 后端服务层
- 使用 NestJS 构建 RESTful API，分层：Controller -> Service -> Repository(ORM)
- 通过 Prisma 访问数据库，提供事务、乐观锁版本（`version` 字段）支持
- 数据校验：DTO + class-validator / zod；响应统一结构 `{ code, message, data }`

#### 4.2.2 数据库
- PostgreSQL 承载核心数据，表：`users`、`wheel_sets`、`wheel_items`
- 重要索引：`wheel_sets(user_id)`、`wheel_items(set_id, order)`
- 变更追踪：`updated_at` + `version`；高并发下用版本号防止覆盖

#### 4.2.3 同步策略
- 前端每次 CRUD 走 API；保存成功后刷新本地 Store
- 乐观更新：前端先更新 UI，再根据 API 结果回滚或确认
- 离线兜底（可选）：仅缓存 `currentWheelSetId` 和最近读取结果；恢复在线后拉取增量

### 4.3 响应式设计方案

#### 4.3.1 断点设计
- Mobile: < 768px
- Tablet: 768px - 1024px  
- Desktop: > 1024px

#### 4.3.2 适配策略
- 转盘大小自适应屏幕尺寸
- 管理界面在移动端采用堆叠布局
- 触摸设备优化交互体验

### 4.4 API 设计

基础路径：`/api/v1`

- 认证
  - `POST /auth/register` 注册
  - `POST /auth/login` 登录（返回 accessToken/refreshToken）
  - `POST /auth/refresh` 刷新 token

- 套餐 WheelSet
  - `GET /wheel-sets` 查询当前用户的套餐列表
  - `POST /wheel-sets` 新建套餐 `{ name }`
  - `GET /wheel-sets/:id` 获取套餐详情（含 items）
  - `PATCH /wheel-sets/:id` 修改 `{ name, version }`
  - `DELETE /wheel-sets/:id`

- 选项 WheelItem（均作用在指定套餐下）
  - `POST /wheel-sets/:id/items` 新增 `{ name, color?, order }`
  - `PATCH /wheel-sets/:id/items/:itemId` 修改 `{ name?, color?, order? }`
  - `DELETE /wheel-sets/:id/items/:itemId`
  - `POST /wheel-sets/:id/items:reorder` 批量排序 `[{ id, order }]`

安全：所有业务接口需 `Authorization: Bearer <token>`；启用 CORS 白名单与速率限制（如 `100 req/5min/ip`）

### 4.5 鉴权与用户体系
- 密码哈希：bcrypt（10-12 轮）
- Token：JWT（HS256），Access 15m，Refresh 7d；Refresh 可在数据库维护黑名单
- 未登录体验（可选）：发放匿名设备 token，登录后将匿名数据归并到账号下

## 5. 性能优化方案

### 5.1 构建优化
- **代码分割**: 路由级别的懒加载
- **资源压缩**: Vite 自动压缩 JS/CSS/HTML
- **Tree Shaking**: 移除未使用的代码
- **Bundle 分析**: 使用 rollup-plugin-visualizer

### 5.2 运行时优化
- **虚拟滚动**: 大量数据列表优化（如有需要）
- **防抖节流**: 用户交互事件优化
- **内存管理**: 及时清理事件监听器和定时器
- **缓存策略**: 合理使用浏览器缓存

后端：
- **连接池**: pg-pool 合理大小
- **缓存**: 读多写少接口可加 Redis（可选）
- **N+1**: ORM 选择 `include` 或 `select` 避免 N+1 查询

### 5.3 动画优化
- **GPU 加速**: 使用 transform3d 触发硬件加速
- **帧率控制**: 确保动画 60fps 流畅度
- **减少重排重绘**: 优化 DOM 操作

## 6. 开发规范

### 6.1 代码规范
- **命名规范**: 
  - 组件名：PascalCase
  - 文件名：kebab-case
  - 变量名：camelCase
  - 常量名：UPPER_SNAKE_CASE

- **组件规范**:
  - 使用 Composition API
  - 单文件组件结构：template -> script -> style
  - Props 定义使用 TypeScript 接口

### 6.2 Git 规范
- **分支策略**: GitFlow
- **提交规范**: Conventional Commits
- **代码审查**: 必须经过 Code Review

### 6.3 测试策略
- **单元测试**: 核心业务逻辑和工具函数
- **组件测试**: 关键 UI 组件
- **端到端测试**: 主要用户流程

## 7. 部署方案

### 7.1 构建配置
- **开发环境**: 前端 Vite HMR；后端 NestJS 热重载（ts-node-dev 或 nest-cli）
- **生产环境**: 前端构建产物托管 Nginx；后端 Node 进程（PM2）或容器部署；开启错误收集

### 7.2 部署策略（容器化推荐）
- `docker-compose` 一键拉起：`web`（静态站点）、`api`（Node）、`db`（Postgres）、`redis`（可选）
- 环境变量：`DATABASE_URL`、`JWT_SECRET`、`CORS_ORIGINS`、`REDIS_URL`
- 数据迁移：`prisma migrate deploy` 随版本发布执行
- 备份：PostgreSQL 定期备份（pg_dump）

### 7.3 CI/CD
- GitHub Actions：
  - `lint`、`typecheck`、`test` 工作流
  - 构建镜像并推送到镜像仓库
  - 部署到服务器/平台（如 Fly.io、Render、阿里云）

## 8. 风险评估与应对

### 8.1 技术风险
- **浏览器兼容性**: 
  - 风险：老版本浏览器不支持某些特性
  - 应对：Polyfill 和特性检测

- **性能问题**:
  - 风险：动画卡顿、内存泄漏
  - 应对：性能监控和优化

- **数据一致性**:
  - 风险：并发保存覆盖、网络抖动导致重复请求
  - 应对：后端使用乐观锁（version 字段）、去重幂等（`Idempotency-Key`）

- **安全**:
  - 风险：越权访问、JWT 泄露
  - 应对：鉴权中间件、RBAC（预留）、HTTPS、Refresh Token 轮换与黑名单

### 8.2 数据风险
- **数据丢失**:
  - 风险：localStorage 被清除
  - 应对：数据导出功能、云端备份（后期）

## 9. 开发计划

### 9.1 开发阶段
1. **第一阶段**: 后端骨架（认证/用户/套餐/选项模块）+ Prisma 建模与迁移
2. **第二阶段**: 前端接入 API（登录、列表、编辑、排序、保存）
3. **第三阶段**: 动画与特效完善、移动端适配、交互优化
4. **第四阶段**: 权限与安全、速率限制、日志与监控
5. **第五阶段**: 容器化与 CI/CD、生产环境部署

### 9.2 里程碑
- **MVP 版本**: 基础转盘功能
- **完整版本**: 包含所有需求功能
- **优化版本**: 性能和体验优化

## 10. 后续扩展技术预研

### 10.1 功能扩展技术方案
- **图片支持**: 使用 Canvas drawImage API
- **分享功能**: Web Share API 或自定义分享
- **历史记录**: IndexedDB 存储大量数据

### 10.2 技术栈升级
- **移动端**: 考虑使用 Capacitor 打包原生应用
- **云端同步**: 后端 API 设计和实现
- **多语言**: Vue I18n 国际化方案 